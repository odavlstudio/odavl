/**
 * Test CVE Scanner
 * Run: pnpm exec tsx test-cve-scanner.ts
 */

import { CVEScannerDetector } from './odavl-studio/insight/core/src/detector/cve-scanner-detector.js';

// ANSI colors
const RED = '\x1b[31m';
const YELLOW = '\x1b[33m';
const CYAN = '\x1b[36m';
const GREEN = '\x1b[32m';
const MAGENTA = '\x1b[35m';
const WHITE = '\x1b[97m';
const RESET = '\x1b[0m';
const BOLD = '\x1b[1m';

async function testCVEScanner() {
  console.log(`${CYAN}${BOLD}ğŸ”’ Testing Advanced CVE Scanner...${RESET}\n`);

  const workspaceRoot = process.cwd();
  const detector = new CVEScannerDetector(workspaceRoot);

  console.log(`${WHITE}ğŸ“‚ Workspace: ${workspaceRoot}${RESET}`);
  console.log(`${WHITE}â³ Scanning dependencies for CVEs...${RESET}\n`);

  try {
    const result = await detector.detect();

    // Display summary
    console.log(`${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}`);
    console.log(`${BOLD}${CYAN}ğŸ“Š CVE SCAN SUMMARY${RESET}`);
    console.log(`${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}\n`);

    console.log(`${WHITE}Total Vulnerabilities: ${BOLD}${result.summary.total}${RESET}`);
    console.log(`${RED}Critical: ${BOLD}${result.summary.critical}${RESET}`);
    console.log(`${YELLOW}High: ${BOLD}${result.summary.high}${RESET}`);
    console.log(`${MAGENTA}Medium: ${BOLD}${result.summary.medium}${RESET}`);
    console.log(`${CYAN}Low: ${BOLD}${result.summary.low}${RESET}`);
    console.log(`${GREEN}Auto-fixable: ${BOLD}${result.summary.autoFixable}${RESET}\n`);

    if (result.issues.length === 0) {
      console.log(`${GREEN}${BOLD}âœ… No vulnerabilities found! Your dependencies are secure.${RESET}\n`);
      return;
    }

    // Display top 10 vulnerabilities
    console.log(`${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}`);
    console.log(`${BOLD}${CYAN}ğŸš¨ TOP VULNERABILITIES (by Risk Score)${RESET}`);
    console.log(`${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}\n`);

    const topIssues = result.issues.slice(0, 10);

    for (let i = 0; i < topIssues.length; i++) {
      const issue = topIssues[i];
      const severityColor = getSeverityColor(issue.severity);
      const severityBadge = getSeverityBadge(issue.severity);

      console.log(`${BOLD}${WHITE}${i + 1}. ${issue.cveId}: ${issue.package}@${issue.version}${RESET}`);
      console.log(`   ${severityColor}${severityBadge}${RESET} ${WHITE}Risk Score: ${BOLD}${issue.riskScore}/100${RESET}`);
      
      if (issue.cvss) {
        console.log(`   ${WHITE}ğŸ“ˆ CVSS: ${BOLD}${issue.cvss}/10${RESET}`);
      }

      console.log(`   ${WHITE}ğŸ“ ${issue.description}${RESET}`);

      if (issue.fixAvailable && issue.suggestedVersion) {
        console.log(`   ${GREEN}âœ… Auto-fix available: ${issue.package}@${issue.suggestedVersion}${RESET}`);
        console.log(`   ${CYAN}ğŸ’¡ Fix: ${BOLD}${issue.fixCommand}${RESET}`);
      } else {
        console.log(`   ${RED}âŒ No automatic fix available${RESET}`);
      }

      if (issue.references.length > 0) {
        console.log(`   ${WHITE}ğŸ”— ${issue.references[0]}${RESET}`);
      }

      console.log(`   ${WHITE}ğŸ“… Published: ${issue.publishedDate.split('T')[0]}${RESET}\n`);
    }

    // Display fix commands
    if (result.summary.autoFixable > 0) {
      console.log(`${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}`);
      console.log(`${BOLD}${CYAN}ğŸ”§ AUTO-FIX COMMANDS${RESET}`);
      console.log(`${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}\n`);

      const fixCommands = detector.getFixCommands(result);
      const uniqueCommands = [...new Set(fixCommands)].slice(0, 5);

      console.log(`${WHITE}Run these commands to fix vulnerabilities:${RESET}\n`);
      
      for (const cmd of uniqueCommands) {
        console.log(`${GREEN}  ${cmd}${RESET}`);
      }

      if (fixCommands.length > 5) {
        console.log(`\n${WHITE}... and ${fixCommands.length - 5} more${RESET}`);
      }

      console.log(`\n${YELLOW}${BOLD}âš ï¸  Or run: npm audit fix${RESET}`);
      console.log(`${WHITE}For automatic fixes of all vulnerabilities${RESET}\n`);
    }

    // Statistics
    console.log(`${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}`);
    console.log(`${BOLD}${CYAN}ğŸ“ˆ SECURITY SCORE${RESET}`);
    console.log(`${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}\n`);

    const securityScore = calculateSecurityScore(result.summary);
    const scoreColor = getScoreColor(securityScore);
    const scoreEmoji = getScoreEmoji(securityScore);

    console.log(`${scoreColor}${BOLD}${scoreEmoji} Security Score: ${securityScore}/100${RESET}`);
    console.log(`${WHITE}${getScoreDescription(securityScore)}${RESET}\n`);

    console.log(`${GREEN}${BOLD}âœ… CVE scan complete!${RESET}\n`);

  } catch (error) {
    console.error(`${RED}${BOLD}âŒ Error during CVE scan:${RESET}`);
    console.error(error);
  }
}

function getSeverityColor(severity: string): string {
  switch (severity) {
    case 'critical': return RED;
    case 'high': return YELLOW;
    case 'medium': return MAGENTA;
    case 'low': return CYAN;
    default: return WHITE;
  }
}

function getSeverityBadge(severity: string): string {
  switch (severity) {
    case 'critical': return '[CRITICAL]';
    case 'high': return '[HIGH]';
    case 'medium': return '[MEDIUM]';
    case 'low': return '[LOW]';
    default: return '[UNKNOWN]';
  }
}

function calculateSecurityScore(summary: any): number {
  // Start with 100, deduct points for vulnerabilities
  let score = 100;

  score -= summary.critical * 20;  // -20 per critical
  score -= summary.high * 10;      // -10 per high
  score -= summary.medium * 5;     // -5 per medium
  score -= summary.low * 2;        // -2 per low

  return Math.max(0, score);
}

function getScoreColor(score: number): string {
  if (score >= 90) return GREEN;
  if (score >= 70) return YELLOW;
  if (score >= 50) return MAGENTA;
  return RED;
}

function getScoreEmoji(score: number): string {
  if (score >= 90) return 'ğŸ›¡ï¸';
  if (score >= 70) return 'âš ï¸';
  if (score >= 50) return 'ğŸš¨';
  return 'ğŸ’€';
}

function getScoreDescription(score: number): string {
  if (score >= 90) return 'Excellent! Your dependencies are very secure.';
  if (score >= 70) return 'Good, but some vulnerabilities need attention.';
  if (score >= 50) return 'Warning: Multiple security issues detected.';
  return 'Critical: Immediate action required!';
}

// Run test
testCVEScanner().catch(console.error);
