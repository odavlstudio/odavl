/**
 * CVE Scanner Detector - Advanced Security Analysis
 * Integrates CVE database scanning with ODAVL Insight
 */

import { CVEScanner, PackageVulnerability } from '../security/cve-scanner.js';

export interface CVEScanResult {
  name: string;
  issues: CVEIssue[];
  summary: {
    total: number;
    critical: number;
    high: number;
    medium: number;
    low: number;
    autoFixable: number;
  };
}

export interface CVEIssue {
  type: 'cve-vulnerability';
  severity: 'critical' | 'high' | 'medium' | 'low';
  message: string;
  package: string;
  version: string;
  cveId: string;
  cvss?: number;
  riskScore: number;
  description: string;
  fixAvailable: boolean;
  suggestedVersion?: string;
  fixCommand?: string;
  references: string[];
  publishedDate: string;
}

export class CVEScannerDetector {
  private workspaceRoot: string;
  private scanner: CVEScanner;

  constructor(workspaceRoot: string) {
    this.workspaceRoot = workspaceRoot;
    this.scanner = new CVEScanner(workspaceRoot);
  }

  /**
   * Detect CVE vulnerabilities
   */
  async detect(): Promise<CVEScanResult> {
    const vulnerabilities = await this.scanner.scan();
    const issues = this.convertToIssues(vulnerabilities);

    return {
      name: 'CVE Scanner',
      issues,
      summary: this.calculateSummary(issues),
    };
  }

  /**
   * Convert vulnerabilities to issues
   */
  private convertToIssues(vulnerabilities: PackageVulnerability[]): CVEIssue[] {
    const issues: CVEIssue[] = [];

    for (const vuln of vulnerabilities) {
      for (const cve of vuln.vulnerabilities) {
        issues.push({
          type: 'cve-vulnerability',
          severity: cve.severity,
          message: `${cve.id}: ${cve.description}`,
          package: vuln.package,
          version: vuln.version,
          cveId: cve.id,
          cvss: cve.cvss,
          riskScore: vuln.riskScore,
          description: cve.description,
          fixAvailable: vuln.autoFixAvailable,
          suggestedVersion: vuln.suggestedVersion,
          fixCommand: vuln.autoFixAvailable && vuln.suggestedVersion 
            ? `npm install ${vuln.package}@${vuln.suggestedVersion}`
            : undefined,
          references: cve.references,
          publishedDate: cve.publishedDate,
        });
      }
    }

    return issues.sort((a, b) => b.riskScore - a.riskScore);
  }

  /**
   * Calculate summary statistics
   */
  private calculateSummary(issues: CVEIssue[]) {
    return {
      total: issues.length,
      critical: issues.filter(i => i.severity === 'critical').length,
      high: issues.filter(i => i.severity === 'high').length,
      medium: issues.filter(i => i.severity === 'medium').length,
      low: issues.filter(i => i.severity === 'low').length,
      autoFixable: issues.filter(i => i.fixAvailable).length,
    };
  }

  /**
   * Get fix commands for all auto-fixable vulnerabilities
   */
  getFixCommands(result: CVEScanResult): string[] {
    return result.issues
      .filter(issue => issue.fixCommand)
      .map(issue => issue.fixCommand!);
  }
}
