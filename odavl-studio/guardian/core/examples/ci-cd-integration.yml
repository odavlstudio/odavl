# GitHub Actions - Guardian CI/CD Integration Example
# Week 11 Day 2 - CI/CD workflow

name: Guardian Quality Gates

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  guardian-tests:
    name: Run Guardian Pre-Deploy Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Build application
        run: pnpm build
      
      - name: Start dev server (background)
        run: |
          pnpm dev &
          sleep 10  # Wait for server to start
      
      - name: Install Guardian
        run: pnpm add -g @odavl-studio/guardian-core
      
      - name: Run Guardian Tests
        run: |
          guardian test http://localhost:3000 --json > guardian-report.json
        continue-on-error: true
      
      - name: Upload Guardian Report
        uses: actions/upload-artifact@v4
        with:
          name: guardian-report
          path: guardian-report.json
      
      - name: Check Quality Gates
        run: |
          node -e "
          const report = require('./guardian-report.json');
          console.log('Overall Score:', report.overallScore);
          console.log('Passed:', report.passed);
          
          if (!report.passed || report.overallScore < 70) {
            console.error('âŒ Quality gates failed!');
            process.exit(1);
          }
          
          console.log('âœ… Quality gates passed!');
          "
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('guardian-report.json', 'utf8'));
            
            const body = `
            ## ðŸ”° Guardian Quality Report
            
            **Overall Score**: ${report.overallScore}/100
            **Status**: ${report.passed ? 'âœ… PASSED' : 'âŒ FAILED'}
            
            ### Test Results
            
            | Test | Score | Status |
            |------|-------|--------|
            | â™¿ Accessibility | ${report.tests.accessibility?.score || 'N/A'}/100 | ${report.tests.accessibility?.score >= 70 ? 'âœ…' : 'âŒ'} |
            | âš¡ Performance | ${report.tests.performance?.scores.performance || 'N/A'}/100 | ${report.tests.performance?.scores.performance >= 70 ? 'âœ…' : 'âŒ'} |
            | ðŸ”’ Security | ${report.tests.security?.score || 'N/A'}/100 | ${report.tests.security?.score >= 70 ? 'âœ…' : 'âŒ'} |
            
            **Duration**: ${(report.duration / 1000).toFixed(1)}s
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

---

# GitLab CI - Guardian Integration Example

guardian_tests:
  stage: test
  image: node:20
  script:
    - npm install -g pnpm
    - pnpm install
    - pnpm build
    - pnpm dev &
    - sleep 10
    - pnpm add -g @odavl-studio/guardian-core
    - guardian test http://localhost:3000 --json > guardian-report.json
    - |
      node -e "
      const report = require('./guardian-report.json');
      if (!report.passed || report.overallScore < 70) process.exit(1);
      "
  artifacts:
    reports:
      junit: guardian-report.json
    paths:
      - guardian-report.json

---

# Azure Pipelines - Guardian Integration Example

trigger:
  - main
  - develop

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: NodeTool@0
  inputs:
    versionSpec: '20.x'

- script: |
    npm install -g pnpm
    pnpm install
    pnpm build
  displayName: 'Build application'

- script: |
    pnpm dev &
    sleep 10
    pnpm add -g @odavl-studio/guardian-core
    guardian test http://localhost:3000 --json > $(Build.ArtifactStagingDirectory)/guardian-report.json
  displayName: 'Run Guardian tests'

- task: PublishBuildArtifacts@1
  inputs:
    pathToPublish: '$(Build.ArtifactStagingDirectory)'
    artifactName: 'guardian-reports'
