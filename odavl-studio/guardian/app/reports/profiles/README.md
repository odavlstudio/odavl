# Performance Profiles

This directory contains CPU profiles and heap snapshots generated by Guardian's performance profiler.

## File Types

### CPU Profiles (`.cpuprofile`)

- **Purpose**: Identify performance bottlenecks and hot code paths
- **Generated by**: POST `/api/performance/profile` with `action: "stop-cpu"`
- **View in**: Chrome DevTools Performance panel (Ctrl+Shift+P → "Load profile")
- **Contains**: Call stacks, hit counts, execution times

### Heap Snapshots (`.heapsnapshot`)

- **Purpose**: Analyze memory usage and detect memory leaks
- **Generated by**: POST `/api/performance/profile` with `action: "heap-snapshot"`
- **View in**: Chrome DevTools Memory panel (click "Load" button)
- **Contains**: Object allocations, retainer paths, memory statistics

## How to Analyze

### CPU Profiling Workflow

```bash
# 1. Start CPU profiling
curl -X POST http://localhost:3000/api/performance/profile \
  -H "Content-Type: application/json" \
  -d '{"action": "start-cpu"}'

# 2. Perform the operation you want to profile
# (e.g., run a load test, execute slow API calls)

# 3. Stop profiling and save
curl -X POST http://localhost:3000/api/performance/profile \
  -H "Content-Type: application/json" \
  -d '{"action": "stop-cpu"}'

# 4. Open the generated .cpuprofile file in Chrome DevTools:
#    - Open Chrome DevTools (F12)
#    - Go to Performance tab
#    - Click "Load profile" button
#    - Select the .cpuprofile file
```

### Heap Snapshot Workflow

```bash
# 1. Take a baseline snapshot before suspicious operation
curl -X POST http://localhost:3000/api/performance/profile \
  -H "Content-Type: application/json" \
  -d '{"action": "heap-snapshot"}'

# 2. Perform the operation that might leak memory
# (e.g., create many objects, run multiple requests)

# 3. Take another snapshot after operation
curl -X POST http://localhost:3000/api/performance/profile \
  -H "Content-Type: application/json" \
  -d '{"action": "heap-snapshot"}'

# 4. Compare snapshots in Chrome DevTools:
#    - Open Chrome DevTools (F12)
#    - Go to Memory tab
#    - Click "Load" button for each snapshot
#    - Use "Comparison" view to find memory growth
```

## File Management

### Auto-Cleanup

Profile files are **not** automatically deleted. To prevent disk space issues:

```bash
# Delete profiles older than 7 days (Linux/Mac)
find ./reports/profiles -name "*.cpuprofile" -mtime +7 -delete
find ./reports/profiles -name "*.heapsnapshot" -mtime +7 -delete

# Windows PowerShell
Get-ChildItem -Path .\reports\profiles -Include *.cpuprofile,*.heapsnapshot -Recurse | 
  Where-Object { $_.LastWriteTime -lt (Get-Date).AddDays(-7) } | 
  Remove-Item
```

### File Naming Convention

- **CPU Profiles**: `cpu-YYYY-MM-DDTHH-MM-SS-sssZ.cpuprofile`
- **Heap Snapshots**: `heap-YYYY-MM-DDTHH-MM-SS-sssZ.heapsnapshot`

Example: `cpu-2025-01-09T14-30-45-123Z.cpuprofile`

## Common Issues

### "Out of Memory" Errors

Heap snapshots can be large (100MB+). Increase Node.js memory:

```bash
NODE_OPTIONS="--max-old-space-size=4096" pnpm start
```

### "Cannot Load Profile" in Chrome

- Ensure the `.cpuprofile` file is complete (profiling fully stopped)
- Check file permissions (should be readable)
- Try copying file to a different location

### "Profiling Already Active"

Only one CPU profiling session can run at a time:

```bash
# Check current status
curl http://localhost:3000/api/performance/profile

# Force stop if needed
curl -X POST http://localhost:3000/api/performance/profile \
  -d '{"action": "stop-cpu"}'
```

## Production Warning

⚠️ **CPU profiling impacts performance.** Only use in production when:

- You have identified a critical performance issue
- The operation is time-limited (< 5 minutes)
- You have monitoring alerts in place

Consider profiling in a staging environment instead.

## Related Documentation

- [Slow Query Logger](../../../src/lib/slow-query-logger.ts) - Database query performance
- [OBSERVABILITY.md](../../../OBSERVABILITY.md) - Metrics and tracing
- [Performance Optimization Guide](../../../docs/PERFORMANCE.md) - Optimization strategies
