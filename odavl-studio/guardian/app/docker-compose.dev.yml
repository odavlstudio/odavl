version: '3.9'

# ============================================
# Development Override Configuration
# ============================================
# Usage: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

services:
  # ============================================
  # PostgreSQL (Development)
  # ============================================
  postgres:
    environment:
      POSTGRES_PASSWORD: devpassword123
    ports:
      - "5433:5432" # Different port to avoid conflicts with local PostgreSQL

  # ============================================
  # Redis (Development)
  # ============================================
  redis:
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "6380:6379" # Different port to avoid conflicts with local Redis

  # ============================================
  # Guardian App (Development)
  # ============================================
  guardian:
    build:
      context: ../..
      dockerfile: apps/guardian/Dockerfile
      target: runner # Use production stage for consistency
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://odavl:devpassword123@postgres:5432/guardian?connection_limit=5&pool_timeout=5&connect_timeout=10
      REDIS_URL: redis://redis:6379
      NEXTAUTH_URL: http://localhost:3001
      NEXTAUTH_SECRET: dev-secret-change-in-production
      JWT_SECRET: dev-jwt-secret-change-in-production
      # Enable Prisma query logs for development
      DEBUG: prisma:query
    ports:
      - "3001:3000" # Different port for development
    volumes:
      # Mount source code for hot reload (if using dev server)
      - ../../apps/guardian/src:/app/apps/guardian/src:ro
      - ../../apps/guardian/.env:/app/apps/guardian/.env:ro
      # Mount ODAVL data for persistence across restarts
      - ./dev-data/.odavl:/app/.odavl
    command: pnpm dev # Use development server instead of production

# ============================================
# Development Volumes
# ============================================
volumes:
  postgres_data:
    name: odavl-guardian-postgres-dev
  redis_data:
    name: odavl-guardian-redis-dev
