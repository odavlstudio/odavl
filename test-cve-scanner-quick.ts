#!/usr/bin/env tsx
import { CVEScanner } from './odavl-studio/insight/core/src/detector/index.js';

async function testCVEScanner() {
  console.log('\nğŸ”’ Testing ODAVL Insight CVE Scanner...\n');
  
  const workspacePath = process.cwd();
  const scanner = new CVEScanner(workspacePath);
  
  try {
    console.log('ğŸ” Scanning for vulnerabilities in node_modules...');
    const vulnerabilities = await scanner.scan();
    
    console.log(`âœ… CVE scan completed!`);
    console.log(`ğŸ“Š Total vulnerabilities found: ${vulnerabilities.length}\n`);
    
    if (vulnerabilities.length > 0) {
      console.log('=== Critical Vulnerabilities (Top 10) ===');
      vulnerabilities
        .filter(v => v.severity === 'critical')
        .slice(0, 10)
        .forEach((vuln, i) => {
          console.log(`\n[${i + 1}] ğŸš¨ ${vuln.title}`);
          console.log(`   ğŸ“¦ Package: ${vuln.packageName}@${vuln.installedVersion}`);
          console.log(`   ğŸ·ï¸  CVE: ${vuln.cve || 'N/A'}`);
          console.log(`   ğŸ’Š Fix: Upgrade to ${vuln.fixedVersion || 'latest'}`);
        });
      
      // Stats
      const stats = {
        critical: vulnerabilities.filter(v => v.severity === 'critical').length,
        high: vulnerabilities.filter(v => v.severity === 'high').length,
        moderate: vulnerabilities.filter(v => v.severity === 'moderate').length,
        low: vulnerabilities.filter(v => v.severity === 'low').length,
      };
      
      console.log('\n=== Vulnerability Summary ===');
      console.log(`ğŸ”´ Critical: ${stats.critical}`);
      console.log(`ğŸŸ  High: ${stats.high}`);
      console.log(`ğŸŸ¡ Moderate: ${stats.moderate}`);
      console.log(`ğŸŸ¢ Low: ${stats.low}`);
      
      console.log(`\nğŸ’¡ Run 'npm audit fix' to resolve some issues automatically`);
    } else {
      console.log('âœ… No vulnerabilities found! Your dependencies are secure.');
    }
    
  } catch (error: any) {
    console.error('âŒ Error running CVE scanner:', error.message);
    console.log('\nğŸ’¡ Tip: Make sure npm is installed and package.json exists');
  }
}

testCVEScanner();
