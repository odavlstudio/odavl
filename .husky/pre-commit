# ODAVL Pre-Commit Hook - Run linting, typecheck, and governance validation

echo "üîç Running pre-commit checks..."

# Run lint-staged for boundary enforcement (priority: check staged files first)
echo "üõ°Ô∏è  Enforcing product boundaries on staged files..."
pnpm exec lint-staged

if [ $? -ne 0 ]; then
  echo "‚ùå Boundary enforcement failed (staged files violate product boundaries)"
  exit 1
fi

# Package versions check
echo "üì¶ Validating package versions..."
tsx scripts/check-package-versions.ts

if [ $? -ne 0 ]; then
  echo "‚ùå Package version validation failed"
  exit 1
fi

# Security audit
echo "üîí Running security audit..."
pnpm audit --audit-level=critical --json > /dev/null 2>&1
if [ $? -ne 0 ]; then
  echo "‚ö†Ô∏è  Critical security vulnerabilities detected (run: pnpm audit)"
  # Don't exit, just warn (high-level vulnerabilities in dependencies are not blocking)
fi

# Verify lockfile
if [ ! -f "pnpm-lock.yaml" ]; then
  echo "‚ùå Missing pnpm-lock.yaml"
  exit 1
fi

# Standard linting and typecheck
echo "üé® Running lint and typecheck..."
pnpm lint && pnpm typecheck

if [ $? -ne 0 ]; then
  echo "‚ùå Lint or typecheck failed"
  exit 1
fi

# ODAVL Governance Validation
echo "üìã Validating .odavl configuration files..."
pnpm tsx tools/validate-odavl-schemas.ts

if [ $? -ne 0 ]; then
  echo "‚ùå Schema validation failed"
  exit 1
fi

# Check metrics directory size
echo "üìä Checking metrics directory..."
METRICS_COUNT=$(find .odavl/metrics -name "*.json" 2>/dev/null | wc -l || echo "0")

if [ "$METRICS_COUNT" -gt 500 ]; then
  echo "‚ö†Ô∏è  Warning: $METRICS_COUNT metrics files (threshold: 500)"
  echo "üí° Consider: pnpm tsx scripts/archive-old-metrics.ts"
fi

if [ "$METRICS_COUNT" -gt 1000 ]; then
  echo "‚ùå Critical: $METRICS_COUNT metrics files (max: 1000)"
  exit 1
fi

# Check undo snapshots
echo "‚è™ Checking undo snapshots..."
UNDO_COUNT=$(find .odavl/undo -name "*.json" ! -name "latest.json" 2>/dev/null | wc -l || echo "0")

if [ "$UNDO_COUNT" -gt 200 ]; then
  echo "‚ùå Critical: $UNDO_COUNT undo snapshots (max: 200)"
  exit 1
fi

echo "‚úÖ All pre-commit checks passed"
exit 0
