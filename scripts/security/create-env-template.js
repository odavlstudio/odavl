#!/usr/bin/env node
/**
 * Create Environment Template
 * Generates .env.example from detected secrets in secrets-report.json
 */

import { promises as fs } from 'node:fs';
import path from 'node:path';

async function handleExistingTemplate(templatePath) {
    try {
        const existing = await fs.readFile(templatePath, 'utf8');
        if (existing.includes('# Generated by ODAVL')) {
            console.log('‚ö†Ô∏è  .env.example already exists with ODAVL content, updating...');
        } else {
            console.log('‚ö†Ô∏è  .env.example exists, backing up to .env.example.backup');
            await fs.writeFile(`${templatePath}.backup`, existing);
        }
    } catch {
        // File doesn't exist, proceed
    }
}

async function updateGitignore(workspaceRoot) {
    const gitignorePath = path.join(workspaceRoot, '.gitignore');
    try {
        let gitignoreContent = await fs.readFile(gitignorePath, 'utf8');
        if (!gitignoreContent.includes('.env')) {
            gitignoreContent += '\n# Environment variables\n.env\n.env.local\n';
            await fs.writeFile(gitignorePath, gitignoreContent);
            console.log('‚úÖ Updated .gitignore to exclude .env files\n');
        }
    } catch {
        console.log('‚ö†Ô∏è  .gitignore not found, skipping update\n');
    }
}

async function main() {
    const workspaceRoot = process.cwd();
    const reportPath = path.join(workspaceRoot, '.odavl', 'security', 'secrets-report.json');

    console.log('üìù Creating .env.example template...\n');

    try {
        const reportContent = await fs.readFile(reportPath, 'utf8');
        const report = JSON.parse(reportContent);

        if (!report.findings || report.findings.length === 0) {
            console.log('‚úÖ No secrets found, no template needed.');
            return;
        }

        // Extract unique variable names from findings
        const envVars = new Set();
        const varDescriptions = new Map();

        for (const finding of report.findings) {
            // Extract variable name from match
            const match = finding.match.match(/([A-Z_][A-Z0-9_]*)\s*[:=]/i);
            if (match && match[1]) {
                const varName = match[1].toUpperCase();
                envVars.add(varName);

                if (!varDescriptions.has(varName)) {
                    varDescriptions.set(varName, {
                        type: finding.secretType,
                        file: finding.file,
                        line: finding.line
                    });
                }
            }
        }

        // Generate .env.example content
        const lines = [
            '# Environment Variables Template',
            '# Generated by ODAVL Security Scanner',
            `# Generated: ${new Date().toISOString()}`,
            '',
            '# SECURITY WARNING: Never commit actual secrets to version control',
            '# Copy this file to .env and fill in your actual values',
            ''
        ];

        for (const varName of Array.from(envVars).sort()) {
            const desc = varDescriptions.get(varName);
            lines.push(
                `# ${desc.type} (found in ${path.basename(desc.file)}:${desc.line})`,
                `${varName}=your_${varName.toLowerCase()}_here`,
                ''
            );
        }

        const templateContent = lines.join('\n');
        const templatePath = path.join(workspaceRoot, '.env.example');

        // Check if .env.example already exists
        await handleExistingTemplate(templatePath);

        await fs.writeFile(templatePath, templateContent);
        console.log(`‚úÖ Created .env.example with ${envVars.size} variables\n`);

        // Also update .gitignore to ensure .env is not committed
        await updateGitignore(workspaceRoot);

        // Print instructions
        console.log('üìã Next steps:');
        console.log('1. Copy .env.example to .env');
        console.log('2. Fill in actual secret values in .env');
        console.log('3. Update your code to use process.env.VARIABLE_NAME');
        console.log('4. Never commit .env to version control\n');

    } catch (error) {
        if (error.code === 'ENOENT') {
            console.error('‚ùå Error: secrets-report.json not found. Run detect-secrets.js first.');
            process.exit(1);
        }
        throw error;
    }
}

await main();
