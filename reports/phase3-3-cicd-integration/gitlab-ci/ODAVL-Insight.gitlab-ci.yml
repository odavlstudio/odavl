# ODAVL-Insight.gitlab-ci.yml
# Include this template in your .gitlab-ci.yml:
# include:
#   - remote: 'https://gitlab.com/odavl-studio/insight/-/raw/main/ODAVL-Insight.gitlab-ci.yml'

.odavl-insight:
  image: node:20-alpine
  cache:
    key: odavl-cache
    paths:
      - .odavl/cache/
  variables:
    ODAVL_LANGUAGES: "auto"
    ODAVL_QUALITY_GATES: "true"
    ODAVL_FAIL_ON_ERROR: "true"
    ODAVL_ERROR_THRESHOLD: "5"
    ODAVL_COMPLEXITY_THRESHOLD: "10"
    ODAVL_COVERAGE_THRESHOLD: "80"
    ODAVL_SECURITY_LEVELS: "critical,high"
  before_script:
    - npm install -g @odavl-studio/cli
  script:
    - odavl insight analyze --ci --format gitlab
    - odavl insight quality-gates --fail-on-error=$ODAVL_FAIL_ON_ERROR
  artifacts:
    reports:
      sast: .odavl/reports/sast-report.json
      coverage_report:
        coverage_format: cobertura
        path: .odavl/reports/coverage.xml
    paths:
      - .odavl/reports/
    expire_in: 30 days
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

odavl-insight-analyze:
  extends: .odavl-insight
  stage: test