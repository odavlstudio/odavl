name: Release

on:
  push:
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      version:
        description: "Release version"
        required: true
        default: "0.1.0"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Governance Gates Check
        run: pwsh .odavl/policy-guard.ps1 --mode pre-check --gates .odavl/gates.yml
      - name: Branch Naming Validation
        run: pwsh .odavl/scripts/validate-branch.ps1
      - name: LOC and File Limits Enforcement
        run: pwsh .odavl/scripts/enforce-limits.ps1 --loc 40 --files 10
      - name: Policy Guard (Post Build)
        run: pwsh .odavl/policy-guard.ps1 --mode post-check --policy .odavl/policy.yml
      - name: Attestation Token Generation
        run: pwsh .odavl/scripts/generate-attestation.ps1 --output .odavl/attestation/attestation-$(date +%Y%m%d).json
      - name: Undo Snapshot Creation
        run: pwsh .odavl/scripts/create-undo.ps1 --output .odavl/undo/undo-$(date +%Y%m%d).json
      - uses: pnpm/action-setup@v4
        with:
          version: 9.12.2
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
      - run: pnpm install --frozen-lockfile
      - run: pnpm typecheck
      - run: pnpm lint
      - name: ðŸ›¡ï¸ Policy Guard Pre-Build
        run: pwsh ./tools/policy-guard.ps1 -Phase pre-build
      - run: pwsh ./tools/release.ps1 -Version ${{ github.event.inputs.version || '0.1.0' }}
      - name: ðŸ›¡ï¸ Policy Guard Post-Build
        run: pwsh ./tools/policy-guard.ps1 -Phase post-build
      - name: Upload Release Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: odavl-release
          path: dist/
          retention-days: 90
      - name: ðŸ›¡ï¸ Attestation Token Generation (JSON)
        run: |
          echo "ðŸ” Generating attestation token..."
          mkdir -p ./evidence/
          echo "{ \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)\", \"branch\": \"${{ github.ref_name }}\", \"commit\": \"${{ github.sha }}\", \"workflow\": \"${{ github.workflow }}\", \"status\": \"passed\" }" > ./evidence/attestation-${{ github.run_id }}.json
          echo "âœ… Attestation token stored in evidence/"
