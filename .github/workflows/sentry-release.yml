name: Sentry Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to create release for (e.g., v2.0.0)'
        required: true
        type: string

jobs:
  create-sentry-release:
    name: Create Sentry Release
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ·ï¸ Get Version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install Sentry CLI
        run: npm install -g @sentry/cli

      - name: ğŸš€ Create Sentry Release
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: odavl-studio
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Create release
          sentry-cli releases new "$VERSION"
          
          # Associate commits
          sentry-cli releases set-commits "$VERSION" --auto
          
          echo "âœ… Sentry release $VERSION created successfully"

      - name: ğŸ“¤ Upload Source Maps (Insight Cloud)
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: odavl-insight-cloud
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          if [ -d "odavl-studio/insight/cloud/.next" ]; then
            sentry-cli releases files "$VERSION" upload-sourcemaps \
              odavl-studio/insight/cloud/.next \
              --url-prefix '~/_next' \
              --validate
            
            echo "âœ… Source maps uploaded for Insight Cloud"
          else
            echo "âš ï¸ .next directory not found - skipping source map upload"
          fi

      - name: ğŸ“¤ Upload Source Maps (Guardian App)
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: odavl-guardian-app
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          if [ -d "odavl-studio/guardian/app/.next" ]; then
            sentry-cli releases files "$VERSION" upload-sourcemaps \
              odavl-studio/guardian/app/.next \
              --url-prefix '~/_next' \
              --validate
            
            echo "âœ… Source maps uploaded for Guardian App"
          else
            echo "âš ï¸ .next directory not found - skipping source map upload"
          fi

      - name: ğŸ“¤ Upload Source Maps (Studio Hub)
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: odavl-studio-hub
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          if [ -d "apps/studio-hub/.next" ]; then
            sentry-cli releases files "$VERSION" upload-sourcemaps \
              apps/studio-hub/.next \
              --url-prefix '~/_next' \
              --validate
            
            echo "âœ… Source maps uploaded for Studio Hub"
          else
            echo "âš ï¸ .next directory not found - skipping source map upload"
          fi

      - name: ğŸ Finalize Sentry Release
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: odavl-studio
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Finalize the release
          sentry-cli releases finalize "$VERSION"
          
          echo "âœ… Sentry release $VERSION finalized"

      - name: ğŸ¯ Deploy to Production Environment
        if: startsWith(steps.version.outputs.version, 'v')
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: odavl-studio
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Mark as deployed to production
          sentry-cli releases deploys "$VERSION" new -e production
          
          echo "âœ… Marked as deployed to production in Sentry"

      - name: ğŸ“Š Create Release Summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          cat > sentry-release-summary.md <<EOF
          # ğŸš€ Sentry Release: $VERSION
          
          ## Release Information
          - **Version**: $VERSION
          - **Created**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Commit**: ${{ github.sha }}
          - **Triggered by**: ${{ github.actor }}
          
          ## Uploaded Source Maps
          - âœ… ODAVL Insight Cloud
          - âœ… ODAVL Guardian App
          - âœ… ODAVL Studio Hub
          
          ## Environment
          - ğŸ¯ Production deployment marked
          - ğŸ“Š Commits associated automatically
          - ğŸ” Source maps uploaded for error tracking
          
          ## Next Steps
          1. Monitor error rates in Sentry dashboard
          2. Set up release alerts for new error types
          3. Review performance metrics
          4. Configure release health tracking
          
          ## Links
          - [Sentry Dashboard](https://sentry.io/organizations/${{ secrets.SENTRY_ORG }}/projects/odavl-studio/)
          - [Release Details](https://sentry.io/organizations/${{ secrets.SENTRY_ORG }}/releases/$VERSION/)
          - [Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF
          
          cat sentry-release-summary.md

      - name: ğŸ“¤ Upload Summary
        uses: actions/upload-artifact@v4
        with:
          name: sentry-release-summary
          path: sentry-release-summary.md
          retention-days: 30

  notify-sentry-integration:
    name: Notify Team
    needs: create-sentry-release
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“Š Integration Status
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ needs.create-sentry-release.result }}';
            const version = '${{ needs.create-sentry-release.outputs.version }}';
            
            let statusEmoji = status === 'success' ? 'âœ…' : 'âŒ';
            let statusText = status === 'success' ? 'SUCCESSFUL' : 'FAILED';
            
            const comment = `## ${statusEmoji} Sentry Release Integration ${statusText}\n\n**Version**: ${version || 'N/A'}\n**Status**: ${statusText}\n**Timestamp**: ${new Date().toISOString()}\n\n### Actions Taken:\n${status === 'success' ? '- âœ… Sentry release created\n- âœ… Source maps uploaded\n- âœ… Commits associated\n- âœ… Marked as deployed to production' : '- âŒ Integration failed - check logs'}\n\n[View Workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
            
            core.info(comment);
