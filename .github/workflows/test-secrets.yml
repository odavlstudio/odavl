name: Test GitHub Secrets

# ğŸ” This workflow verifies that all required GitHub Secrets are configured
# Run this after adding secrets to ensure everything is set up correctly

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      verbose:
        description: 'Show detailed output'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  test-secrets:
    name: Verify Secrets Configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ¯ Check Database Secrets
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Database Secrets"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ -n "${{ secrets.STAGING_DATABASE_URL }}" ]; then
            echo "âœ… STAGING_DATABASE_URL"
            if [ "${{ inputs.verbose }}" = "true" ]; then
              # Show first 20 chars only (for verification)
              echo "   â†’ ${STAGING_DB_URL:0:20}..."
            fi
          else
            echo "âŒ STAGING_DATABASE_URL - MISSING (CRITICAL)"
            exit 1
          fi
          
          if [ -n "${{ secrets.PRODUCTION_DATABASE_URL }}" ]; then
            echo "âœ… PRODUCTION_DATABASE_URL"
          else
            echo "âŒ PRODUCTION_DATABASE_URL - MISSING (CRITICAL)"
            exit 1
          fi
        env:
          STAGING_DB_URL: ${{ secrets.STAGING_DATABASE_URL }}

      - name: ğŸ” Check Authentication Secrets
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”‘ Authentication Secrets"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ -n "${{ secrets.STAGING_NEXTAUTH_SECRET }}" ]; then
            echo "âœ… STAGING_NEXTAUTH_SECRET"
            # Verify length (should be 32+ chars)
            length=${#STAGING_SECRET}
            if [ $length -ge 32 ]; then
              echo "   â†’ Length: $length chars (valid)"
            else
              echo "   âš ï¸  Length: $length chars (too short, should be 32+)"
            fi
          else
            echo "âŒ STAGING_NEXTAUTH_SECRET - MISSING (CRITICAL)"
            exit 1
          fi
          
          if [ -n "${{ secrets.PRODUCTION_NEXTAUTH_SECRET }}" ]; then
            echo "âœ… PRODUCTION_NEXTAUTH_SECRET"
          else
            echo "âŒ PRODUCTION_NEXTAUTH_SECRET - MISSING (CRITICAL)"
            exit 1
          fi
          
          if [ -n "${{ secrets.STAGING_URL }}" ]; then
            echo "âœ… STAGING_URL"
            if [ "${{ inputs.verbose }}" = "true" ]; then
              echo "   â†’ ${{ secrets.STAGING_URL }}"
            fi
          else
            echo "âŒ STAGING_URL - MISSING (CRITICAL)"
            exit 1
          fi
        env:
          STAGING_SECRET: ${{ secrets.STAGING_NEXTAUTH_SECRET }}

      - name: ğŸš€ Check Vercel Secrets
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Vercel Deployment Secrets"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ -n "${{ secrets.VERCEL_TOKEN }}" ]; then
            echo "âœ… VERCEL_TOKEN"
          else
            echo "âŒ VERCEL_TOKEN - MISSING (CRITICAL)"
            exit 1
          fi
          
          if [ -n "${{ secrets.VERCEL_ORG_ID }}" ]; then
            echo "âœ… VERCEL_ORG_ID"
            if [ "${{ inputs.verbose }}" = "true" ]; then
              echo "   â†’ ${{ secrets.VERCEL_ORG_ID }}"
            fi
          else
            echo "âŒ VERCEL_ORG_ID - MISSING (CRITICAL)"
            exit 1
          fi
          
          if [ -n "${{ secrets.VERCEL_PROJECT_ID }}" ]; then
            echo "âœ… VERCEL_PROJECT_ID"
            if [ "${{ inputs.verbose }}" = "true" ]; then
              echo "   â†’ ${{ secrets.VERCEL_PROJECT_ID }}"
            fi
          else
            echo "âŒ VERCEL_PROJECT_ID - MISSING (CRITICAL)"
            exit 1
          fi

      - name: ğŸ›¡ï¸ Check Security Secrets
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ›¡ï¸  Security Secrets"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ -n "${{ secrets.SNYK_TOKEN }}" ]; then
            echo "âœ… SNYK_TOKEN"
          else
            echo "âŒ SNYK_TOKEN - MISSING (CRITICAL)"
            exit 1
          fi
          
          if [ -n "${{ secrets.SNYK_ORG_ID }}" ]; then
            echo "âœ… SNYK_ORG_ID"
            if [ "${{ inputs.verbose }}" = "true" ]; then
              echo "   â†’ ${{ secrets.SNYK_ORG_ID }}"
            fi
          else
            echo "âŒ SNYK_ORG_ID - MISSING (CRITICAL)"
            exit 1
          fi

      - name: ğŸ“¢ Check Notification Secrets
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¢ Notification Secrets"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ -n "${{ secrets.SLACK_WEBHOOK }}" ]; then
            echo "âœ… SLACK_WEBHOOK"
            if [ "${{ inputs.verbose }}" = "true" ]; then
              # Show URL structure (hide token)
              echo "   â†’ https://hooks.slack.com/services/***"
            fi
          else
            echo "âŒ SLACK_WEBHOOK - MISSING (CRITICAL)"
            exit 1
          fi

      - name: ğŸŒ Check Cloudflare Secrets (Optional)
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Cloudflare CDN Secrets (Optional)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ -n "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" ]; then
            echo "âœ… CLOUDFLARE_ACCOUNT_ID"
          else
            echo "âš ï¸  CLOUDFLARE_ACCOUNT_ID - Not configured (optional)"
          fi
          
          if [ -n "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            echo "âœ… CLOUDFLARE_API_TOKEN"
          else
            echo "âš ï¸  CLOUDFLARE_API_TOKEN - Not configured (optional)"
          fi
          
          if [ -n "${{ secrets.CLOUDFLARE_ZONE_ID }}" ]; then
            echo "âœ… CLOUDFLARE_ZONE_ID"
          else
            echo "âš ï¸  CLOUDFLARE_ZONE_ID - Not configured (optional)"
          fi

      - name: â˜ï¸ Check AWS Secrets (Optional)
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â˜ï¸  AWS Secrets (Optional)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ -n "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
            echo "âœ… AWS_ACCESS_KEY_ID"
          else
            echo "âš ï¸  AWS_ACCESS_KEY_ID - Not configured (optional)"
          fi
          
          if [ -n "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "âœ… AWS_SECRET_ACCESS_KEY"
          else
            echo "âš ï¸  AWS_SECRET_ACCESS_KEY - Not configured (optional)"
          fi
          
          if [ -n "${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}" ]; then
            echo "âœ… CLOUDFRONT_DISTRIBUTION_ID"
          else
            echo "âš ï¸  CLOUDFRONT_DISTRIBUTION_ID - Not configured (optional)"
          fi

      - name: ğŸ”· Check Azure Secrets (Optional)
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”· Azure Secrets (Optional)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ -n "${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" ]; then
            echo "âœ… AZURE_STORAGE_CONNECTION_STRING"
          else
            echo "âš ï¸  AZURE_STORAGE_CONNECTION_STRING - Not configured (optional)"
          fi

      - name: ğŸ” Check GitLeaks (Optional)
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” GitLeaks Secrets (Optional)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ -n "${{ secrets.GITLEAKS_LICENSE }}" ]; then
            echo "âœ… GITLEAKS_LICENSE"
          else
            echo "âš ï¸  GITLEAKS_LICENSE - Not configured (optional, works in free mode)"
          fi

      - name: ğŸ“Š Generate Summary
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Count configured secrets
          required=0
          optional=0
          
          # Required (11 critical secrets)
          [ -n "${{ secrets.STAGING_DATABASE_URL }}" ] && ((required++))
          [ -n "${{ secrets.PRODUCTION_DATABASE_URL }}" ] && ((required++))
          [ -n "${{ secrets.STAGING_NEXTAUTH_SECRET }}" ] && ((required++))
          [ -n "${{ secrets.PRODUCTION_NEXTAUTH_SECRET }}" ] && ((required++))
          [ -n "${{ secrets.STAGING_URL }}" ] && ((required++))
          [ -n "${{ secrets.VERCEL_TOKEN }}" ] && ((required++))
          [ -n "${{ secrets.VERCEL_ORG_ID }}" ] && ((required++))
          [ -n "${{ secrets.VERCEL_PROJECT_ID }}" ] && ((required++))
          [ -n "${{ secrets.SNYK_TOKEN }}" ] && ((required++))
          [ -n "${{ secrets.SNYK_ORG_ID }}" ] && ((required++))
          [ -n "${{ secrets.SLACK_WEBHOOK }}" ] && ((required++))
          
          # Optional (8 secrets)
          [ -n "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" ] && ((optional++))
          [ -n "${{ secrets.CLOUDFLARE_API_TOKEN }}" ] && ((optional++))
          [ -n "${{ secrets.CLOUDFLARE_ZONE_ID }}" ] && ((optional++))
          [ -n "${{ secrets.AWS_ACCESS_KEY_ID }}" ] && ((optional++))
          [ -n "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ] && ((optional++))
          [ -n "${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}" ] && ((optional++))
          [ -n "${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" ] && ((optional++))
          [ -n "${{ secrets.GITLEAKS_LICENSE }}" ] && ((optional++))
          
          total=$((required + optional))
          
          echo "âœ… Required Secrets:  $required / 11"
          echo "âš ï¸  Optional Secrets:  $optional / 8"
          echo "ğŸ“Š Total Configured: $total / 19"
          echo ""
          
          if [ $required -eq 11 ]; then
            echo "ğŸ‰ All required secrets are configured!"
            echo ""
            echo "Next steps:"
            echo "  1. Test deployment: gh workflow run deploy-staging.yml"
            echo "  2. Monitor workflow: gh run list"
            echo "  3. Check logs if issues: gh run view --log"
          else
            echo "âŒ Missing $(($11 - $required)) required secret(s)"
            echo ""
            echo "Please add the missing secrets:"
            echo "  1. Read guide: .github/SECRETS_SETUP_GUIDE.md"
            echo "  2. Add via UI: https://github.com/[OWNER]/[REPO]/settings/secrets/actions"
            echo "  3. Or via CLI: pwsh scripts/add-github-secrets.ps1"
            exit 1
          fi

      - name: ğŸ§ª Test Slack Notification
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "ğŸ” GitHub Secrets Verification Complete",
              "attachments": [{
                "color": "good",
                "fields": [{
                  "title": "Status",
                  "value": "âœ… All required secrets configured",
                  "short": true
                }, {
                  "title": "Repository",
                  "value": "${{ github.repository }}",
                  "short": true
                }]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      - name: âŒ Notify Failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "ğŸ” GitHub Secrets Verification Failed",
              "attachments": [{
                "color": "danger",
                "fields": [{
                  "title": "Status",
                  "value": "âŒ Some required secrets are missing",
                  "short": true
                }, {
                  "title": "Action",
                  "value": "Check workflow logs for details",
                  "short": true
                }]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
