name: Deploy to Production

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., v1.0.0)'
        required: true

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://odavl-insight.vercel.app
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name || github.event.inputs.version }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.2

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run full test suite
        run: |
          pnpm test
          pnpm test:e2e

      - name: Security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --fail-on=upgradable

      - name: Build application
        run: |
          cd odavl-studio/insight/cloud
          pnpm build
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.PRODUCTION_NEXTAUTH_SECRET }}
          NEXTAUTH_URL: https://odavl-insight.vercel.app
          NODE_ENV: production

      - name: Backup database
        run: |
          echo "Creating database backup..."
          BACKUP_FILE="backup-$(date +%Y%m%d-%H%M%S).sql"
          pg_dump $DATABASE_URL > $BACKUP_FILE
          echo "‚úÖ Database backup created: $BACKUP_FILE"
          # Upload to artifact storage
          mkdir -p ./backups
          mv $BACKUP_FILE ./backups/
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}

      - name: Deploy to Vercel (Production)
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./odavl-studio/insight/cloud
          vercel-args: '--prod'
          scope: ${{ secrets.VERCEL_ORG_ID }}

      - name: Wait for deployment
        run: sleep 30

      - name: Health check
        run: |
          for i in {1..10}; do
            if curl -f https://odavl-insight.vercel.app/api/health; then
              echo "Health check passed"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 5
          done
          echo "Health check failed after 10 attempts"
          exit 1

      - name: Smoke tests
        run: |
          # Test critical endpoints
          curl -f https://odavl-insight.vercel.app/ || exit 1
          curl -f https://odavl-insight.vercel.app/api/health || exit 1
          curl -f https://odavl-insight.vercel.app/dashboard/overview || exit 1

      - name: Notify Slack (Success)
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: "üöÄ Production Deployment Successful!",
              attachments: [{
                color: 'good',
                fields: [
                  { title: 'Version', value: '${{ github.event.release.tag_name || github.event.inputs.version }}', short: true },
                  { title: 'Deployed by', value: '${{ github.actor }}', short: true },
                  { title: 'Commit', value: '${{ github.sha }}', short: false },
                  { title: 'URL', value: 'https://odavl-insight.vercel.app', short: false }
                ]
              }]
            }
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed, initiating rollback..."
          # Add rollback logic here
          # vercel rollback --token=${{ secrets.VERCEL_TOKEN }}

      - name: Notify Slack (Failure)
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: "‚ùå Production Deployment Failed!",
              attachments: [{
                color: 'danger',
                fields: [
                  { title: 'Version', value: '${{ github.event.release.tag_name || github.event.inputs.version }}', short: true },
                  { title: 'Failed by', value: '${{ github.actor }}', short: true },
                  { title: 'Action', value: 'Rollback initiated', short: false }
                ]
              }]
            }
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

      - name: Create deployment record
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const deployment = {
              version: '${{ github.event.release.tag_name || github.event.inputs.version }}',
              timestamp: new Date().toISOString(),
              actor: '${{ github.actor }}',
              status: '${{ job.status }}',
              commit: '${{ github.sha }}'
            };
            
            console.log('Deployment record:', deployment);
            // Could save to database or file
