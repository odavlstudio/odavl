name: Guardian CI/CD Pipeline

on:
    push:
        branches:
            - main
            - develop
        paths:
            - "apps/guardian/**"
            - "packages/**"
            - ".github/workflows/guardian-*.yml"
    pull_request:
        branches:
            - main
            - develop
        paths:
            - "apps/guardian/**"
            - "packages/**"
    workflow_dispatch:
        inputs:
            environment:
                description: "Environment to deploy to"
                required: true
                default: "staging"
                type: choice
                options:
                    - staging
                    - production

env:
    NODE_VERSION: "20"
    PNPM_VERSION: "9"
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}/guardian

jobs:
    # Job 1: Lint and Type Check
    lint:
        name: Lint & Type Check
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: apps/guardian

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run ESLint
              run: pnpm lint

            - name: Run TypeScript check
              run: pnpm tsc --noEmit

    # Job 2: Unit Tests
    test:
        name: Unit Tests
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: apps/guardian

        services:
            postgres:
                image: postgres:16-alpine
                env:
                    POSTGRES_DB: guardian_test
                    POSTGRES_USER: test
                    POSTGRES_PASSWORD: test
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
                ports:
                    - 5432:5432

            redis:
                image: redis:7-alpine
                options: >-
                    --health-cmd "redis-cli ping"
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
                ports:
                    - 6379:6379

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Setup test database
              env:
                  DATABASE_URL: postgresql://test:test@localhost:5432/guardian_test
              run: |
                  pnpm prisma migrate deploy
                  pnpm prisma generate

            - name: Run unit tests
              env:
                  DATABASE_URL: postgresql://test:test@localhost:5432/guardian_test
                  REDIS_URL: redis://localhost:6379
                  JWT_SECRET: test-jwt-secret-for-ci-testing-only
                  NODE_ENV: test
              run: pnpm test --coverage

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v4
              with:
                  files: ./apps/guardian/coverage/lcov.info
                  flags: guardian
                  name: guardian-coverage

    # Job 3: E2E Tests
    e2e:
        name: E2E Tests
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: apps/guardian

        services:
            postgres:
                image: postgres:16-alpine
                env:
                    POSTGRES_DB: guardian_e2e
                    POSTGRES_USER: test
                    POSTGRES_PASSWORD: test
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
                ports:
                    - 5432:5432

            redis:
                image: redis:7-alpine
                options: >-
                    --health-cmd "redis-cli ping"
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
                ports:
                    - 6379:6379

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Install Playwright browsers
              run: pnpm exec playwright install --with-deps chromium

            - name: Setup database
              env:
                  DATABASE_URL: postgresql://test:test@localhost:5432/guardian_e2e
              run: |
                  pnpm prisma migrate deploy
                  pnpm prisma generate

            - name: Build application
              env:
                  DATABASE_URL: postgresql://test:test@localhost:5432/guardian_e2e
                  REDIS_URL: redis://localhost:6379
                  JWT_SECRET: test-jwt-secret-for-e2e-testing
              run: pnpm build

            - name: Run E2E tests
              env:
                  DATABASE_URL: postgresql://test:test@localhost:5432/guardian_e2e
                  REDIS_URL: redis://localhost:6379
                  JWT_SECRET: test-jwt-secret-for-e2e-testing
                  NEXT_PUBLIC_SOCKET_URL: http://localhost:3001
              run: pnpm test:e2e

            - name: Upload Playwright report
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: playwright-report
                  path: apps/guardian/playwright-report/
                  retention-days: 30

    # Job 4: Security Scan
    security:
        name: Security Scan
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: apps/guardian

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: "fs"
                  scan-ref: "apps/guardian"
                  format: "sarif"
                  output: "trivy-results.sarif"

            - name: Upload Trivy results to GitHub Security
              uses: github/codeql-action/upload-sarif@v3
              with:
                  sarif_file: "trivy-results.sarif"

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Run pnpm audit
              run: pnpm audit --audit-level=high
              continue-on-error: true

    # Job 5: Build Docker Image
    build:
        name: Build Docker Image
        runs-on: ubuntu-latest
        needs: [lint, test, e2e, security]
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

        permissions:
            contents: read
            packages: write

        outputs:
            image-tag: ${{ steps.meta.outputs.tags }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
                  tags: |
                      type=ref,event=branch
                      type=ref,event=pr
                      type=semver,pattern={{version}}
                      type=semver,pattern={{major}}.{{minor}}
                      type=sha,prefix={{branch}}-

            - name: Build and push Docker image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: apps/guardian/Dockerfile
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
                  build-args: |
                      NODE_ENV=production

    # Job 6: Deploy to Staging
    deploy-staging:
        name: Deploy to Staging
        runs-on: ubuntu-latest
        needs: [build]
        if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
        environment:
            name: staging
            url: https://guardian-staging.odavl.com

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Deploy to staging
              env:
                  DEPLOY_KEY: ${{ secrets.STAGING_DEPLOY_KEY }}
                  STAGING_HOST: ${{ secrets.STAGING_HOST }}
                  IMAGE_TAG: ${{ needs.build.outputs.image-tag }}
              run: |
                  echo "Deploying Guardian to staging environment..."
                  echo "Image: $IMAGE_TAG"
                  # Add deployment script here (SSH, kubectl, docker-compose, etc.)

            - name: Run smoke tests
              env:
                  STAGING_URL: https://guardian-staging.odavl.com
              run: |
                  echo "Running smoke tests..."
                  # Add smoke test script here

            - name: Notify deployment success
              if: success()
              uses: 8398a7/action-slack@v3
              with:
                  status: success
                  text: "Guardian deployed successfully to staging! :rocket:"
                  webhook_url: ${{ secrets.SLACK_WEBHOOK }}

    # Job 7: Deploy to Production
    deploy-production:
        name: Deploy to Production
        runs-on: ubuntu-latest
        needs: [build]
        if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
        environment:
            name: production
            url: https://guardian.odavl.com

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Deploy to production
              env:
                  DEPLOY_KEY: ${{ secrets.PRODUCTION_DEPLOY_KEY }}
                  PRODUCTION_HOST: ${{ secrets.PRODUCTION_HOST }}
                  IMAGE_TAG: ${{ needs.build.outputs.image-tag }}
              run: |
                  echo "Deploying Guardian to production environment..."
                  echo "Image: $IMAGE_TAG"
                  # Add deployment script here

            - name: Run smoke tests
              env:
                  PRODUCTION_URL: https://guardian.odavl.com
              run: |
                  echo "Running production smoke tests..."
                  # Add smoke test script here

            - name: Notify deployment success
              if: success()
              uses: 8398a7/action-slack@v3
              with:
                  status: success
                  text: "Guardian deployed successfully to production! :rocket:"
                  webhook_url: ${{ secrets.SLACK_WEBHOOK }}

            - name: Rollback on failure
              if: failure()
              run: |
                  echo "Deployment failed! Rolling back..."
                  # Add rollback script here
