name: ODAVL Autonomous Loop

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main]
    schedule:
        # Run every 6 hours (00:00, 06:00, 12:00, 18:00 UTC)
        - cron: "0 */6 * * *"
    workflow_dispatch:
        inputs:
            plan_path:
                description: "Path to ODAVL plan file (optional)"
                required: false
                type: string

jobs:
    odavl-loop:
        name: Run ODAVL Autonomous Loop
        runs-on: ubuntu-latest
        timeout-minutes: 30

        permissions:
            contents: write
            pull-requests: write
            issues: write

        steps:
            - name: ğŸ“¥ Checkout Repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: ğŸ“¦ Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9.12.2

            - name: ğŸ“¦ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "pnpm"

            - name: ğŸ“¥ Install Dependencies
              run: pnpm install --frozen-lockfile

            - name: ğŸ” Run ODAVL Loop
              id: odavl_run
              run: |
                  if [ -n "${{ github.event.inputs.plan_path }}" ]; then
                    pnpm odavl:run --plan="${{ github.event.inputs.plan_path }}"
                  else
                    pnpm odavl:run
                  fi
              continue-on-error: true

            - name: ğŸ“Š Parse Results
              id: parse_results
              run: |
                  # Get latest ledger file
                  LEDGER_FILE=$(ls -t .odavl/ledger/run-*.json 2>/dev/null | head -1)

                  if [ -f "$LEDGER_FILE" ]; then
                    echo "ledger_path=$LEDGER_FILE" >> $GITHUB_OUTPUT
                    
                    # Extract key metrics
                    GATES_PASSED=$(jq -r '.payload.notes.verify.gatesPassed // false' "$LEDGER_FILE")
                    echo "gates_passed=$GATES_PASSED" >> $GITHUB_OUTPUT
                    
                    TOTAL_ISSUES=$(jq -r '.payload.notes.observe.totalIssues // 0' "$LEDGER_FILE")
                    echo "total_issues=$TOTAL_ISSUES" >> $GITHUB_OUTPUT
                    
                    RECIPE_ID=$(jq -r '.payload.decision // "none"' "$LEDGER_FILE")
                    echo "recipe_id=$RECIPE_ID" >> $GITHUB_OUTPUT
                    
                    # Check if trust was updated
                    TRUST_UPDATED=$(jq -r '.payload.notes.learn.trustUpdated // false' "$LEDGER_FILE")
                    echo "trust_updated=$TRUST_UPDATED" >> $GITHUB_OUTPUT
                    
                    echo "âœ… Results parsed successfully"
                  else
                    echo "âš ï¸  No ledger file found"
                    echo "gates_passed=false" >> $GITHUB_OUTPUT
                    echo "total_issues=0" >> $GITHUB_OUTPUT
                    echo "recipe_id=none" >> $GITHUB_OUTPUT
                    echo "trust_updated=false" >> $GITHUB_OUTPUT
                  fi

            - name: ğŸ“¤ Upload ODAVL Reports
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: odavl-reports-${{ github.run_number }}
                  path: |
                      .odavl/ledger/
                      .odavl/metrics/
                      .odavl/recipes-trust.json
                      .odavl/history.json
                      .odavl/attestation/
                      reports/
                  retention-days: 30

            - name: ğŸ“Š Comment on PR (Pull Request)
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const ledgerPath = '${{ steps.parse_results.outputs.ledger_path }}';

                      let comment = '## ğŸ¤– ODAVL Autonomous Loop Results\n\n';

                      if (fs.existsSync(ledgerPath)) {
                        const ledger = JSON.parse(fs.readFileSync(ledgerPath, 'utf8'));
                        
                        comment += `**Quality Gates:** ${{ steps.parse_results.outputs.gates_passed == 'true' ? 'âœ… PASSED' : 'âŒ FAILED' }}\n`;
                        comment += `**Total Issues Detected:** ${{ steps.parse_results.outputs.total_issues }}\n`;
                        comment += `**Recipe Applied:** \`${{ steps.parse_results.outputs.recipe_id }}\`\n`;
                        comment += `**Trust Updated:** ${{ steps.parse_results.outputs.trust_updated == 'true' ? 'âœ… Yes' : 'âŒ No' }}\n\n`;
                        
                        comment += '### ğŸ“‹ Phase Summary\n\n';
                        comment += '| Phase | Status | Details |\n';
                        comment += '|-------|--------|----------|\n';
                        
                        const phases = ['observe', 'decide', 'act', 'verify', 'learn'];
                        phases.forEach(phase => {
                          const note = ledger.payload?.notes?.[phase];
                          if (note) {
                            const status = note.status === 'complete' ? 'âœ…' : 'âŒ';
                            const details = note.message || note.error || 'N/A';
                            comment += `| ${phase.toUpperCase()} | ${status} | ${details} |\n`;
                          }
                        });
                        
                        comment += '\n---\n';
                        comment += `ğŸ“Š [View Full Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n`;
                      } else {
                        comment += 'âš ï¸ No ledger file found. ODAVL loop may have failed to start.\n';
                      }

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: comment
                      });

            - name: âœ… Check Quality Gates
              if: github.event_name == 'pull_request'
              run: |
                  if [ "${{ steps.parse_results.outputs.gates_passed }}" != "true" ]; then
                    echo "âŒ Quality gates failed - blocking PR merge"
                    exit 1
                  fi
                  echo "âœ… Quality gates passed"

            - name: ğŸ“ Commit Trust Score Updates
              if: |
                  github.event_name != 'pull_request' &&
                  steps.parse_results.outputs.trust_updated == 'true'
              run: |
                  git config user.name "ODAVL Bot"
                  git config user.email "odavl@github-actions"

                  # Add trust and history files
                  git add .odavl/recipes-trust.json .odavl/history.json

                  # Check if there are changes to commit
                  if git diff --staged --quiet; then
                    echo "No changes to commit"
                  else
                    git commit -m "chore(odavl): update trust scores and history [skip ci]
                    
                    - Recipe: ${{ steps.parse_results.outputs.recipe_id }}
                    - Gates Passed: ${{ steps.parse_results.outputs.gates_passed }}
                    - Issues Detected: ${{ steps.parse_results.outputs.total_issues }}
                    - Run: ${{ github.run_number }}"
                    
                    git push
                    echo "âœ… Trust scores committed"
                  fi

            - name: ğŸš¨ Notify on Failure
              if: failure() && github.event_name == 'schedule'
              uses: actions/github-script@v7
              with:
                  script: |
                      github.rest.issues.create({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        title: `ğŸš¨ ODAVL Loop Failed - Run #${{ github.run_number }}`,
                        body: `The scheduled ODAVL loop run failed.\n\n**Details:**\n- Run ID: ${{ github.run_id }}\n- Recipe: ${{ steps.parse_results.outputs.recipe_id }}\n- Issues: ${{ steps.parse_results.outputs.total_issues }}\n\n[View Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`,
                        labels: ['odavl', 'automated', 'ci-failure']
                      });

    verify-tests:
        name: Verify All Tests
        runs-on: ubuntu-latest
        timeout-minutes: 15

        steps:
            - name: ğŸ“¥ Checkout Repository
              uses: actions/checkout@v4

            - name: ğŸ“¦ Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9.12.2

            - name: ğŸ“¦ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "pnpm"

            - name: ğŸ“¥ Install Dependencies
              run: pnpm install --frozen-lockfile

            - name: ğŸ§ª Run All Tests
              run: pnpm test

            - name: ğŸ“Š Upload Test Results
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: test-results-${{ github.run_number }}
                  path: reports/test-results.json
                  retention-days: 30
