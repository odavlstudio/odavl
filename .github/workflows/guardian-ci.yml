name: Guardian CI/CD Pipeline

on:
    push:
        branches: [main, develop]
        paths:
            - "apps/guardian/**"
            - "packages/**"
            - ".github/workflows/guardian-ci.yml"
    pull_request:
        branches: [main, develop]
        paths:
            - "apps/guardian/**"
            - "packages/**"
    workflow_dispatch:

env:
    NODE_VERSION: "20"
    PNPM_VERSION: "9"
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}/guardian

jobs:
    # ============================================
    # Stage 1: Lint & Type Check
    # ============================================
    lint:
        name: Lint & Type Check
        runs-on: ubuntu-latest
        timeout-minutes: 10

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup pnpm
              uses: pnpm/action-setup@v3
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run ESLint
              run: pnpm --filter=@odavl/guardian lint

            - name: Run TypeScript check
              run: pnpm --filter=@odavl/guardian exec tsc --noEmit

            - name: Check formatting (Prettier)
              run: pnpm --filter=@odavl/guardian exec prettier --check "src/**/*.{ts,tsx,js,jsx,json,md}"

    # ============================================
    # Stage 2: Unit & Integration Tests
    # ============================================
    test:
        name: Unit & Integration Tests
        runs-on: ubuntu-latest
        timeout-minutes: 15

        services:
            postgres:
                image: postgres:16-alpine
                env:
                    POSTGRES_USER: odavl
                    POSTGRES_PASSWORD: testpass123
                    POSTGRES_DB: guardian_test
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

            redis:
                image: redis:7-alpine
                ports:
                    - 6379:6379
                options: >-
                    --health-cmd "redis-cli ping"
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v3
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Generate Prisma client
              run: |
                  cd apps/guardian
                  pnpm exec prisma generate

            - name: Run database migrations
              env:
                  DATABASE_URL: postgresql://odavl:testpass123@localhost:5432/guardian_test
              run: |
                  cd apps/guardian
                  pnpm exec prisma migrate deploy

            - name: Run unit tests
              env:
                  DATABASE_URL: postgresql://odavl:testpass123@localhost:5432/guardian_test
                  REDIS_URL: redis://localhost:6379
                  NODE_ENV: test
              run: pnpm --filter=@odavl/guardian test

            - name: Generate coverage report
              env:
                  DATABASE_URL: postgresql://odavl:testpass123@localhost:5432/guardian_test
                  REDIS_URL: redis://localhost:6379
                  NODE_ENV: test
              run: pnpm --filter=@odavl/guardian test:coverage

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v4
              with:
                  files: ./apps/guardian/coverage/coverage-final.json
                  flags: guardian
                  name: guardian-coverage
                  fail_ci_if_error: false

    # ============================================
    # Stage 3: Security Scan
    # ============================================
    security:
        name: Security Scan
        runs-on: ubuntu-latest
        timeout-minutes: 10

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v3
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run npm audit
              run: pnpm audit --production --audit-level=moderate

            - name: Run Snyk security scan
              uses: snyk/actions/node@master
              continue-on-error: true
              env:
                  SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
              with:
                  args: --severity-threshold=high --file=apps/guardian/package.json

    # ============================================
    # Stage 4: Build Docker Image
    # ============================================
    build:
        name: Build Docker Image
        runs-on: ubuntu-latest
        needs: [lint, test]
        timeout-minutes: 20
        permissions:
            contents: read
            packages: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
                  tags: |
                      type=ref,event=branch
                      type=ref,event=pr
                      type=semver,pattern={{version}}
                      type=semver,pattern={{major}}.{{minor}}
                      type=sha,prefix={{branch}}-
                      type=raw,value=latest,enable={{is_default_branch}}

            - name: Build and push Docker image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./apps/guardian/Dockerfile
                  platforms: linux/amd64,linux/arm64
                  push: ${{ github.event_name != 'pull_request' }}
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
                  build-args: |
                      NODE_ENV=production
                      NEXT_TELEMETRY_DISABLED=1

    # ============================================
    # Stage 5: Deploy to Staging (main branch)
    # ============================================
    deploy-staging:
        name: Deploy to Staging
        runs-on: ubuntu-latest
        needs: [build]
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        timeout-minutes: 10
        environment:
            name: staging
            url: https://guardian-staging.odavl.com

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Deploy to staging
              run: |
                  echo "üöÄ Deploying to staging environment..."
                  # Add deployment commands here (Kubernetes, AWS ECS, etc.)
                  # Example: kubectl set image deployment/guardian guardian=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

            - name: Wait for deployment
              run: sleep 30

            - name: Run health check
              run: |
                  response=$(curl -s -o /dev/null -w "%{http_code}" https://guardian-staging.odavl.com/api/health)
                  if [ $response -eq 200 ]; then
                    echo "‚úÖ Health check passed (HTTP $response)"
                  else
                    echo "‚ùå Health check failed (HTTP $response)"
                    exit 1
                  fi

            - name: Run smoke tests
              run: |
                  echo "üß™ Running smoke tests..."
                  # Add smoke test commands here
                  # Example: pnpm --filter=@odavl/guardian test:e2e:smoke

    # ============================================
    # Stage 6: Deploy to Production (manual)
    # ============================================
    deploy-production:
        name: Deploy to Production
        runs-on: ubuntu-latest
        needs: [build]
        if: github.ref == 'refs/heads/main' && github.event_name == 'workflow_dispatch'
        timeout-minutes: 15
        environment:
            name: production
            url: https://guardian.odavl.com

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Deploy to production
              run: |
                  echo "üöÄ Deploying to production environment..."
                  # Add production deployment commands here
                  # Example: kubectl set image deployment/guardian guardian=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

            - name: Wait for deployment
              run: sleep 60

            - name: Run health check
              run: |
                  response=$(curl -s -o /dev/null -w "%{http_code}" https://guardian.odavl.com/api/health)
                  if [ $response -eq 200 ]; then
                    echo "‚úÖ Health check passed (HTTP $response)"
                  else
                    echo "‚ùå Health check failed (HTTP $response)"
                    exit 1
                  fi

            - name: Run smoke tests
              run: |
                  echo "üß™ Running smoke tests..."
                  # Add smoke test commands here

            - name: Notify deployment success
              if: success()
              run: |
                  echo "‚úÖ Production deployment successful!"
                  # Add notification commands (Slack, email, etc.)

            - name: Rollback on failure
              if: failure()
              run: |
                  echo "‚ùå Production deployment failed. Rolling back..."
                  # Add rollback commands here
                  # Example: kubectl rollout undo deployment/guardian
