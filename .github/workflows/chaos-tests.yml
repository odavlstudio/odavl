name: Weekly Chaos Engineering Tests

on:
  # Weekly schedule - Saturdays at 3 AM UTC (low traffic period)
  schedule:
    - cron: "0 3 * * 6"
  
  # Manual trigger with experiment selection
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production
      
      experiment:
        description: "Chaos experiment to run"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - database-pod-failure
          - database-connection-pool
          - database-slow-query
          - network-partition
          - network-latency
          - network-packet-loss
          - pod-cpu-stress
          - pod-memory-stress
      
      skip_validation:
        description: "Skip pre-experiment validation"
        required: false
        default: false
        type: boolean

env:
  CHAOS_NAMESPACE: ${{ github.event.inputs.environment == 'production' && 'odavl-production' || 'odavl-staging' }}
  BASE_URL: ${{ github.event.inputs.environment == 'production' && secrets.PROD_URL || secrets.STAGING_URL }}
  PROMETHEUS_URL: ${{ secrets.PROMETHEUS_URL }}

jobs:
  validate-environment:
    name: Validate Environment
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_validation }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "v1.28.0"
      
      - name: Configure kubectl context
        run: |
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > kubeconfig.yaml
          export KUBECONFIG=kubeconfig.yaml
          kubectl config use-context ${{ env.CHAOS_NAMESPACE }}
      
      - name: Check cluster health
        run: |
          kubectl get nodes
          kubectl get pods -n ${{ env.CHAOS_NAMESPACE }}
      
      - name: Verify application health
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.BASE_URL }}/api/health)
          if [ $response -ne 200 ]; then
            echo "Application health check failed: HTTP $response"
            exit 1
          fi
          echo "Application is healthy (HTTP 200)"
      
      - name: Check error rate baseline
        run: |
          error_rate=$(curl -s "${{ env.PROMETHEUS_URL }}/api/v1/query?query=(sum(rate(http_requests_total{status=~\"5..\"}[5m])) / sum(rate(http_requests_total[5m]))) * 100" | jq -r '.data.result[0].value[1]')
          echo "Current error rate: $error_rate%"
          if (( $(echo "$error_rate > 1" | bc -l) )); then
            echo "Error rate too high ($error_rate% > 1%). Aborting chaos tests."
            exit 1
          fi
  
  run-chaos-experiments:
    name: Run Chaos Experiments
    runs-on: ubuntu-latest
    needs: [validate-environment]
    if: always() && (needs.validate-environment.result == 'success' || inputs.skip_validation)
    
    strategy:
      matrix:
        experiment: 
          ${{ github.event.inputs.experiment == 'all' && fromJson('["database-pod-failure", "database-connection-pool", "database-slow-query", "network-partition", "network-latency", "network-packet-loss", "pod-cpu-stress", "pod-memory-stress"]') || fromJson(format('["{0}"]', github.event.inputs.experiment)) }}
      fail-fast: false
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      
      - name: Install Chaos Toolkit
        run: |
          pip install --upgrade pip
          pip install chaostoolkit chaostoolkit-kubernetes chaostoolkit-prometheus
          chaos --version
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "v1.28.0"
      
      - name: Configure kubectl context
        run: |
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > kubeconfig.yaml
          export KUBECONFIG=kubeconfig.yaml
          kubectl config use-context ${{ env.CHAOS_NAMESPACE }}
      
      - name: Set environment variables
        run: |
          echo "CHAOS_K8S_NAMESPACE=${{ env.CHAOS_NAMESPACE }}" >> $GITHUB_ENV
          echo "BASE_URL=${{ env.BASE_URL }}" >> $GITHUB_ENV
          echo "PROMETHEUS_URL=${{ env.PROMETHEUS_URL }}" >> $GITHUB_ENV
          echo "SLACK_CHAOS_WEBHOOK_URL=${{ secrets.SLACK_CHAOS_WEBHOOK_URL }}" >> $GITHUB_ENV
      
      - name: Run chaos experiment - ${{ matrix.experiment }}
        id: chaos
        continue-on-error: true
        run: |
          mkdir -p reports/chaos
          
          chaos run \
            apps/studio-hub/chaos/experiments/${{ matrix.experiment }}.json \
            --journal-path reports/chaos/${{ matrix.experiment }}-journal.json \
            --report-path reports/chaos/${{ matrix.experiment }}-report.html
      
      - name: Analyze experiment results
        if: always()
        run: |
          if [ -f reports/chaos/${{ matrix.experiment }}-journal.json ]; then
            # Extract key metrics from journal
            steady_state_passed=$(jq -r '.steady_states.before.steady_state_met' reports/chaos/${{ matrix.experiment }}-journal.json)
            steady_state_after=$(jq -r '.steady_states.after.steady_state_met' reports/chaos/${{ matrix.experiment }}-journal.json)
            
            echo "Experiment: ${{ matrix.experiment }}"
            echo "Steady state before: $steady_state_passed"
            echo "Steady state after: $steady_state_after"
            
            if [ "$steady_state_passed" = "true" ] && [ "$steady_state_after" = "true" ]; then
              echo "‚úÖ Experiment passed - System recovered"
              echo "result=passed" >> $GITHUB_OUTPUT
            else
              echo "‚ùå Experiment failed - System did not recover"
              echo "result=failed" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ö†Ô∏è Journal file not found"
            echo "result=error" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload experiment artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: chaos-experiment-${{ matrix.experiment }}-${{ github.run_number }}
          path: |
            reports/chaos/${{ matrix.experiment }}-journal.json
            reports/chaos/${{ matrix.experiment }}-report.html
          retention-days: 90
      
      - name: Notify Slack on failure
        if: failure() && github.event_name == 'schedule'
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_CHAOS_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "üö® Chaos Experiment Failed",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üö® Chaos Experiment Failed"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Experiment:*\n${{ matrix.experiment }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\n${{ env.CHAOS_NAMESPACE }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Run:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Action Required:*\n‚Ä¢ Review experiment journal\n‚Ä¢ Check system recovery\n‚Ä¢ Update incident response procedures"
                  }
                }
              ]
            }
  
  create-incident-report:
    name: Create Incident Report
    runs-on: ubuntu-latest
    needs: [run-chaos-experiments]
    if: failure() && github.event_name == 'schedule'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: reports/chaos
      
      - name: Create GitHub Issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Find failed experiments
            const reportsDir = 'reports/chaos';
            const failedExperiments = [];
            
            // Read all journal files
            const artifacts = fs.readdirSync(reportsDir);
            for (const artifact of artifacts) {
              const journalPath = path.join(reportsDir, artifact, `${artifact.replace('chaos-experiment-', '').replace(/-\d+$/, '')}-journal.json`);
              if (fs.existsSync(journalPath)) {
                const journal = JSON.parse(fs.readFileSync(journalPath, 'utf8'));
                if (!journal.steady_states.after.steady_state_met) {
                  failedExperiments.push({
                    name: artifact.replace('chaos-experiment-', '').replace(/-\d+$/, ''),
                    journal: journal
                  });
                }
              }
            }
            
            if (failedExperiments.length === 0) {
              console.log('No failed experiments found');
              return;
            }
            
            // Create issue body
            const today = new Date().toISOString().split('T')[0];
            let body = `## üö® Chaos Engineering Failure Report\n\n`;
            body += `**Date:** ${today}\n`;
            body += `**Environment:** ${process.env.CHAOS_NAMESPACE}\n`;
            body += `**Run:** [View Workflow](${context.payload.repository.html_url}/actions/runs/${context.runId})\n\n`;
            body += `### Failed Experiments (${failedExperiments.length})\n\n`;
            
            for (const exp of failedExperiments) {
              body += `#### ${exp.name}\n\n`;
              body += `**Steady State Before:** ${exp.journal.steady_states.before.steady_state_met ? '‚úÖ Passed' : '‚ùå Failed'}\n`;
              body += `**Steady State After:** ${exp.journal.steady_states.after.steady_state_met ? '‚úÖ Passed' : '‚ùå Failed'}\n\n`;
            }
            
            body += `### Investigation Steps\n\n`;
            body += `1. Review experiment journals in artifacts\n`;
            body += `2. Check Grafana dashboards for anomalies\n`;
            body += `3. Review application logs during experiment window\n`;
            body += `4. Verify circuit breakers activated correctly\n`;
            body += `5. Check database connection pool metrics\n\n`;
            
            body += `### Recommended Actions\n\n`;
            body += `- [ ] Update circuit breaker thresholds\n`;
            body += `- [ ] Increase connection pool limits\n`;
            body += `- [ ] Add additional retry logic\n`;
            body += `- [ ] Improve error handling\n`;
            body += `- [ ] Update incident response procedures\n`;
            body += `- [ ] Schedule postmortem meeting\n\n`;
            
            body += `### Team Mentions\n\n`;
            body += `@odavl/devops @odavl/backend @odavl/sre`;
            
            // Create issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Chaos Engineering Failures - ${today}`,
              body: body,
              labels: ['chaos-engineering', 'resilience', 'urgent', 'incident'],
              assignees: []
            });

permissions:
  contents: read
  issues: write
  actions: read
