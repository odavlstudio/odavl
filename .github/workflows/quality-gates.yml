name: Quality Gates & Tests

on:
    push:
        branches: [main, develop, "feature/**", "fix/**"]
    pull_request:
        branches: [main, develop]
    workflow_dispatch:

jobs:
    lint-and-typecheck:
        name: Lint & Type Check
        runs-on: ubuntu-latest
        timeout-minutes: 10

        steps:
            - name: ðŸ“¥ Checkout
              uses: actions/checkout@v4

            - name: ðŸ“¦ Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9.12.2

            - name: ðŸ“¦ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "pnpm"

            - name: ðŸ“¥ Install Dependencies
              run: pnpm install --frozen-lockfile

            - name: ðŸ” ESLint
              run: pnpm lint

            - name: ðŸ” TypeScript Check
              run: npx tsc --noEmit

    test:
        name: Unit & Integration Tests
        runs-on: ubuntu-latest
        timeout-minutes: 15

        steps:
            - name: ðŸ“¥ Checkout
              uses: actions/checkout@v4

            - name: ðŸ“¦ Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9.12.2

            - name: ðŸ“¦ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "pnpm"

            - name: ðŸ“¥ Install Dependencies
              run: pnpm install --frozen-lockfile

            - name: ðŸ§ª Run Tests with Coverage
              run: pnpm test:coverage

            - name: ðŸ“Š Upload Coverage
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: coverage-${{ github.run_number }}
                  path: |
                      reports/test-results.json
                      coverage/
                  retention-days: 30

    forensic:
        name: Forensic Analysis
        runs-on: ubuntu-latest
        timeout-minutes: 15

        steps:
            - name: ðŸ“¥ Checkout
              uses: actions/checkout@v4

            - name: ðŸ“¦ Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9.12.2

            - name: ðŸ“¦ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "pnpm"

            - name: ðŸ“¥ Install Dependencies
              run: pnpm install --frozen-lockfile

            - name: ðŸ”¬ Run Forensic Analysis
              run: pnpm forensic:all
              continue-on-error: true

            - name: ðŸ“Š Upload Forensic Reports
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: forensic-reports-${{ github.run_number }}
                  path: reports/forensic/
                  retention-days: 30

    security-scan:
        name: Security Scan
        runs-on: ubuntu-latest
        timeout-minutes: 10

        steps:
            - name: ðŸ“¥ Checkout
              uses: actions/checkout@v4

            - name: ðŸ“¦ Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9.12.2

            - name: ðŸ“¦ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "pnpm"

            - name: ðŸ“¥ Install Dependencies
              run: pnpm install --frozen-lockfile

            - name: ðŸ”’ Run Security Scan
              run: |
                  if [ -f "tools/security-scan.ps1" ]; then
                    pwsh tools/security-scan.ps1
                  else
                    echo "âš ï¸  Security scan script not found"
                  fi
              continue-on-error: true

            - name: ðŸ“Š Upload Security Reports
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: security-reports-${{ github.run_number }}
                  path: security/
                  retention-days: 30

    quality-summary:
        name: Quality Summary
        needs: [lint-and-typecheck, test, forensic, security-scan]
        runs-on: ubuntu-latest
        if: always()

        steps:
            - name: ðŸ“Š Check Results
              run: |
                  echo "## Quality Gates Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
                  echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
                  echo "| Lint & Type Check | ${{ needs.lint-and-typecheck.result }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Forensic | ${{ needs.forensic.result }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Security | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  if [ "${{ needs.lint-and-typecheck.result }}" != "success" ] || [ "${{ needs.test.result }}" != "success" ]; then
                    echo "âŒ **Quality gates FAILED**" >> $GITHUB_STEP_SUMMARY
                    exit 1
                  else
                    echo "âœ… **Quality gates PASSED**" >> $GITHUB_STEP_SUMMARY
                  fi
