name: ODAVL Architecture Gate ğŸ›¡ï¸

on:
  push:
    branches: [main, develop, 'odavl/**']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  boundary-enforcement:
    name: "ğŸ›¡ï¸ Product Boundary Enforcement"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate blame
      
      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.2
          run_install: false
      
      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: ğŸ” Lint with boundary enforcement
        id: lint
        run: |
          echo "=== ODAVL ARCHITECTURE GATE ==="
          echo "Scanning for product boundary violations..."
          pnpm exec eslint \
            "odavl-studio/insight/**/*.ts" \
            "odavl-studio/autopilot/**/*.ts" \
            "odavl-studio/guardian/**/*.ts" \
            --format json --output-file eslint-report.json || true
          
          # Check if any violations exist
          VIOLATIONS=$(cat eslint-report.json | jq '[.[] | .messages[]] | length')
          echo "violations=$VIOLATIONS" >> $GITHUB_OUTPUT
          
          if [ "$VIOLATIONS" -gt 0 ]; then
            echo "âŒ Found $VIOLATIONS boundary violations"
            cat eslint-report.json | jq -r '.[] | .messages[] | "âŒ \(.ruleId) in \(.filePath):\(.line):\(.column) - \(.message)"'
            exit 1
          else
            echo "âœ… No boundary violations detected"
          fi
      
      - name: ğŸ“Š Upload ESLint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: eslint-boundary-report
          path: eslint-report.json
          retention-days: 30
  
  architecture-validation:
    name: "ğŸ“ Architecture Validation"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.2
          run_install: false
      
      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: âœ… Verify product structure
        run: |
          echo "=== VERIFYING ODAVL PRODUCT STRUCTURE ==="
          
          # Check Insight structure (Detection ONLY)
          echo "ğŸ” Checking Insight (Detection ONLY)..."
          if [ -d "odavl-studio/insight/core/src/fixer" ]; then
            echo "âŒ VIOLATION: Insight contains fixer/ directory (should be removed)"
            exit 1
          fi
          if grep -r "AutoFixEngine\|FixApplier" odavl-studio/insight/core/src/ 2>/dev/null; then
            echo "âŒ VIOLATION: Insight contains auto-fix code"
            exit 1
          fi
          echo "âœ… Insight structure valid (Detection only)"
          
          # Check Autopilot structure (Fixing ONLY)
          echo "ğŸ¤– Checking Autopilot (Fixing ONLY)..."
          if grep -r "AnalysisProtocol" odavl-studio/autopilot/engine/src/phases/ 2>/dev/null; then
            echo "âŒ VIOLATION: Autopilot uses AnalysisProtocol (should read Insight JSON)"
            exit 1
          fi
          if [ -d "odavl-studio/autopilot/engine/src/detectors" ]; then
            echo "âŒ VIOLATION: Autopilot contains detectors/ directory"
            exit 1
          fi
          echo "âœ… Autopilot structure valid (Fixing only)"
          
          # Check Guardian structure (Website Testing ONLY)
          echo "ğŸ›¡ï¸ Checking Guardian (Website Testing ONLY)..."
          if [ -d "odavl-studio/guardian/core/src/inspectors" ]; then
            echo "âŒ VIOLATION: Guardian contains inspectors/ (code analysis)"
            exit 1
          fi
          if [ -d "odavl-studio/guardian/core/src/fixers" ]; then
            echo "âŒ VIOLATION: Guardian contains fixers/ directory"
            exit 1
          fi
          if grep -r "TypeScriptDetector\|ESLintDetector" odavl-studio/guardian/ 2>/dev/null; then
            echo "âŒ VIOLATION: Guardian imports code analysis detectors"
            exit 1
          fi
          echo "âœ… Guardian structure valid (Website testing only)"
          
          echo ""
          echo "âœ… ALL ARCHITECTURE CHECKS PASSED"
  
  governance-validation:
    name: "ğŸ“‹ Governance Policy Validation"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.2
          run_install: false
      
      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: ğŸ“‹ Validate .odavl.policy.yml
        run: |
          if [ ! -f ".odavl.policy.yml" ]; then
            echo "âš ï¸  Warning: .odavl.policy.yml not found (governance rules not enforced)"
            exit 0
          fi
          
          echo "=== VALIDATING GOVERNANCE POLICY ==="
          pnpm exec tsx tools/validate-odavl-schemas.ts
          echo "âœ… Governance policy valid"
  
  attestation-check:
    name: "ğŸ” Attestation Chain Validation"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ” Verify attestation integrity
        run: |
          echo "=== ATTESTATION CHAIN VALIDATION ==="
          
          # Check if attestation directory exists
          if [ ! -d ".odavl/attestation" ]; then
            echo "âš ï¸  No attestation directory found (no automated changes yet)"
            exit 0
          fi
          
          # Verify SHA-256 checksums
          for file in .odavl/attestation/*.json; do
            if [ -f "$file" ]; then
              echo "Validating: $file"
              # Extract hash and verify it matches file content
              # (Simplified validation - production would use proper crypto library)
              if grep -q "sha256" "$file"; then
                echo "âœ… Attestation found: $(basename $file)"
              else
                echo "âŒ Invalid attestation: $(basename $file)"
                exit 1
              fi
            fi
          done
          
          echo "âœ… All attestations valid"
