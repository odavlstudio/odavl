// Multi-Tenant Database Schema Extensions
// Add to apps/studio-hub/prisma/schema.prisma

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  logoUrl     String?
  websiteUrl  String?

  // Subscription
  plan        SubscriptionPlan @default(FREE)
  planStatus  PlanStatus       @default(ACTIVE)

  // Billing
  stripeCustomerId       String?   @unique
  stripeSubscriptionId   String?   @unique
  currentPeriodStart     DateTime?
  currentPeriodEnd       DateTime?

  // Usage limits based on plan
  maxMembers      Int      @default(5)
  maxProjects     Int      @default(10)
  maxApiCalls     Int      @default(10000)
  maxStorage      BigInt   @default(1073741824) // 1GB in bytes

  // Settings
  settings    Json?

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  members     OrganizationMember[]
  projects    Project[]
  invitations OrganizationInvitation[]
  apiKeys     ApiKey[]
  usageRecords UsageRecord[]
  webhooks    Webhook[]

  @@index([slug])
  @@index([stripeCustomerId])
  @@map("organizations")
}

model OrganizationMember {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  role           MemberRole @default(MEMBER)

  // Permissions (can be customized per member)
  permissions    Json?

  // Status
  status         MemberStatus @default(ACTIVE)

  // Timestamps
  joinedAt       DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([userId])
  @@index([organizationId, role])
  @@map("organization_members")
}

model OrganizationInvitation {
  id             String   @id @default(cuid())
  organizationId String
  email          String
  role           MemberRole @default(MEMBER)

  // Invitation token
  token          String   @unique @default(cuid())

  // Status
  status         InvitationStatus @default(PENDING)

  // Invited by
  invitedById    String
  invitedBy      User     @relation(fields: [invitedById], references: [id])

  // Acceptance
  acceptedAt     DateTime?
  acceptedById   String?

  // Expiration
  expiresAt      DateTime

  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email])
  @@index([token])
  @@index([email])
  @@map("organization_invitations")
}

model Project {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  description    String?

  // Project settings
  settings       Json?

  // Workspace
  workspacePath  String?
  lastSyncAt     DateTime?

  // Status
  status         ProjectStatus @default(ACTIVE)

  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  errorSignatures ErrorSignature[]

  @@index([organizationId])
  @@index([organizationId, status])
  @@map("projects")
}

model Webhook {
  id             String   @id @default(cuid())
  organizationId String

  // Webhook config
  url            String
  events         String[] // ['insight.run', 'autopilot.complete', 'guardian.failed', etc.]
  secret         String   // For signature verification

  // Status
  enabled        Boolean  @default(true)

  // Retry config
  maxRetries     Int      @default(3)
  retryDelay     Int      @default(1000) // milliseconds

  // Stats
  totalCalls     Int      @default(0)
  successfulCalls Int     @default(0)
  failedCalls    Int      @default(0)
  lastCalledAt   DateTime?

  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  deliveries     WebhookDelivery[]

  @@index([organizationId])
  @@index([organizationId, enabled])
  @@map("webhooks")
}

model WebhookDelivery {
  id             String   @id @default(cuid())
  webhookId      String

  // Delivery details
  event          String
  payload        Json

  // Response
  statusCode     Int?
  responseBody   String?
  responseTime   Int?     // milliseconds

  // Status
  status         DeliveryStatus @default(PENDING)
  attempts       Int      @default(0)
  nextRetryAt    DateTime?

  // Error
  error          String?

  // Timestamps
  createdAt      DateTime @default(now())
  completedAt    DateTime?

  // Relations
  webhook        Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([status])
  @@index([createdAt])
  @@map("webhook_deliveries")
}

// Enums

enum SubscriptionPlan {
  FREE
  STARTER    // $49/month
  PROFESSIONAL // $149/month
  ENTERPRISE // Custom pricing
}

enum PlanStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum MemberStatus {
  ACTIVE
  SUSPENDED
  INVITED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELED
}

enum ProjectStatus {
  ACTIVE
  ARCHIVED
  DELETED
}

enum DeliveryStatus {
  PENDING
  SUCCESS
  FAILED
  RETRYING
}

// Update existing models

model User {
  // ... existing fields ...

  // Add multi-tenant relations
  organizationMemberships OrganizationMember[]
  invitationsSent         OrganizationInvitation[]

  // Default organization
  defaultOrganizationId   String?
}

model ApiKey {
  // ... existing fields ...

  // Add organization relation
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

model UsageRecord {
  // ... existing fields ...

  // Add organization relation
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}
